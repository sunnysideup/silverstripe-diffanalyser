#!/usr/bin/env php
<?php

use Sunnysideup\DiffAnalyser\GitDiffAnalyser;

// Usage information
if (in_array('--help', $argv) || in_array('-h', $argv)) {
    echo <<<EOL
Usage: php git-diff-analyser [--days=1] [--branch=develop] [--filter=sunnysideup] [--date=YYYY-MM-DD] [--minutes-for-first-line=1] [-v|-vv|-vvv]

Options:
  --days=N                     Number of days to go back in time for the analysis (default: 1).
  --branch=NAME                Specify the branch to analyze (default: develop).
  --filter=STRING              Filter git repos by their remote URL (default: 'sunnysideup').
  --date=YYYY-MM-DD            Analyze for a specific date instead of days back.
  --minutes-for-first-line=N   Set the number of minutes for the first line of code change (default: 20).
  -v, -vv, -vvv                Set verbosity level:
                                 -v   : Show total time and total changes only.
                                 -vv  : Show commit messages, file changes, and total time (default).
                                 -vvv : Show detailed changes for each file.
  -h, --help                   Show this help message.

Examples:
  sake-git-diff-analyser --days=7 --branch=main --filter=myorganization
  sake-git-diff-analyser --date=2024-09-24 --minutes-for-first-line=20
  sake-git-diff-analyser -v --days=5 --filter=mycompany

EOL;
    exit;
}

// CLI argument handling
$options = getopt('', ['days:', 'branch:', 'filter:', 'minutes-for-first-line:', 'date:', 'v::']);
$days = isset($options['days']) ? (int)$options['days'] : 1;
$branch = $options['branch'] ?? 'develop';
$filter = $options['filter'] ?? 'sunnysideup';
$minutesForFirstLineChange = isset($options['minutes-for-first-line']) ? (float)$options['minutes-for-first-line'] : 20;
$date = $options['date'] ?? null;
$verbosity = isset($options['v']) ? strlen($options['v']) : 2;
if ($date) {
    $daysOrDate = $date;
} else {
    $daysOrDate = $days;
}

// Create an instance of the GitDiffAnalyzer and run the analysis
$analyzer = new GitDiffAnalyser(
    $daysOrDate,
    $branch,
    $filter,
    $minutesForFirstLineChange,
    $verbosity
);
$analyzer->run();
